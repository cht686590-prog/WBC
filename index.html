<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>普普風雲端點餐系統</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 1. React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 2. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #fffbf2; }
        
        /* Custom Scrollbar */
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-fade-in-up { animation: fadeInUp 0.4s ease-out; }
    </style>
</head>
<body class="selection:bg-amber-200 pb-20">

    <div id="root">
        <!-- 預設載入畫面，避免空白 -->
        <div class="fixed inset-0 flex items-center justify-center bg-[#fffbf2]">
            <div class="text-center animate-pulse">
                <h2 class="text-2xl font-bold text-amber-600 mb-2">系統載入中...</h2>
                <p class="text-gray-500">正在連接雲端資料庫</p>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-[9999] flex flex-col items-center space-y-2 pointer-events-none w-full max-w-sm px-4"></div>

    <script type="text/babel" data-type="module">
        // ==========================================
        // ⚠️⚠️⚠️ 下載後，請在此處填入您的 Firebase 設定 ⚠️⚠️⚠️
        // ==========================================
        const manualFirebaseConfig = {
            apiKey: "AIzaSyCb6XyW3sFVxhFbnhZsDWUQ0g2MT__G6I4",
            authDomain: "users-bf3ee.firebaseapp.com",
            projectId: "users-bf3ee",
            storageBucket: "users-bf3ee.firebasestorage.app",
            messagingSenderId: "514281139179",
            appId: "1:514281139179:web:22af49132c17ad77b207ae"
        };
        // ==========================================

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js';
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js';

        const { useState, useContext, createContext, useEffect, useMemo, useRef } = React;
        
        // --- 內建圖示庫 (解決 CDN 載入失敗問題) ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );

        const Icons = {
            ShoppingCart: (props) => <IconBase {...props}><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></IconBase>,
            X: (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>,
            ChevronDown: (props) => <IconBase {...props}><path d="m6 9 6 6 6-6"/></IconBase>,
            Plus: (props) => <IconBase {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>,
            Minus: (props) => <IconBase {...props}><path d="M5 12h14"/></IconBase>,
            Coffee: (props) => <IconBase {...props}><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" x2="6" y1="2" y2="4"/><line x1="10" x2="10" y1="2" y2="4"/><line x1="14" x2="14" y1="2" y2="4"/></IconBase>,
            Soup: (props) => <IconBase {...props}><path d="M12 21a9 9 0 0 0 9-9H3a9 9 0 0 0 9 9Z"/><path d="M7 21v-8a3 3 0 0 1 6 0v8"/><path d="M12 21v-8a3 3 0 0 1 6 0v8"/></IconBase>,
            Utensils: (props) => <IconBase {...props}><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></IconBase>,
            CakeSlice: (props) => <IconBase {...props}><circle cx="9" cy="7" r="4"/><path d="M7.2 3.8 2 22h20l-9.2-8.3a4 4 0 0 0-5.6 0"/></IconBase>, // Simplified replacement
            IceCream: (props) => <IconBase {...props}><path d="m7 11 4.08 10.35a1 1 0 0 0 1.84 0L17 11"/><path d="M17 7A5 5 0 0 0 7 7"/><path d="M17 7a2 2 0 0 1 0 4H7a2 2 0 0 1 0-4"/></IconBase>,
            Search: (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>,
            Copy: (props) => <IconBase {...props}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></IconBase>,
            FileText: (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></IconBase>,
            Trash2: (props) => <IconBase {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1.1-.9 2-2 2H7c-1.1 0-2-.9-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>,
            Check: (props) => <IconBase {...props}><path d="M20 6 9 17l-5-5"/></IconBase>,
            Bell: (props) => <IconBase {...props}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></IconBase>,
            User: (props) => <IconBase {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>,
            ChefHat: (props) => <IconBase {...props}><path d="M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 7.08 0A5.11 5.11 0 0 1 16.59 6 4 4 0 0 1 18 13.87V21H6Z"/><line x1="6" x2="18" y1="17" y2="17"/></IconBase>,
            RefreshCw: (props) => <IconBase {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconBase>,
            List: (props) => <IconBase {...props}><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></IconBase>,
            Lock: (props) => <IconBase {...props}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>,
            LogOut: (props) => <IconBase {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></IconBase>,
            Edit3: (props) => <IconBase {...props}><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></IconBase>,
            Save: (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>,
            AlertCircle: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>,
            Info: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></IconBase>,
            PlusCircle: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="16"/><line x1="8" x2="16" y1="12" y2="12"/></IconBase>,
            DollarSign: (props) => <IconBase {...props}><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></IconBase>,
        };

        const { ShoppingCart, X, ChevronDown, Plus, Minus, Coffee, Soup, Utensils, CakeSlice, IceCream, Search, Copy, FileText, Trash2, Check, Bell, User, ChefHat, RefreshCw, List, Lock, LogOut, Edit3, Save, AlertCircle, Info, PlusCircle, DollarSign } = Icons;

        // --- Initialization Logic ---
        let firebaseConfig = manualFirebaseConfig;
        let appId = 'popo-ordering-system-v1';

        if (typeof __firebase_config !== 'undefined') {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
                if (typeof __app_id !== 'undefined') appId = __app_id;
            } catch (e) {
                console.warn("Failed to parse environment config");
            }
        }

        if (!firebaseConfig || !firebaseConfig.apiKey) {
            const root = document.getElementById('root');
            root.innerHTML = `
                <div class="fixed inset-0 flex items-center justify-center bg-red-50 p-6">
                    <div class="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full border-2 border-red-100">
                        <h2 class="text-2xl font-black text-red-600 mb-4">⚠️ 尚未設定 Firebase</h2>
                        <p class="text-gray-700 mb-4 font-bold">系統檢測不到有效的資料庫金鑰。</p>
                        <ul class="list-disc pl-5 space-y-2 text-gray-600 text-sm mb-6">
                            <li>如果您正在<b>預覽環境</b>：請確認環境變數是否正常載入。</li>
                            <li>如果您已<b>下載檔案</b>：請使用文字編輯器開啟此檔案，並在 <code>manualFirebaseConfig</code> 處填入您的 Firebase 設定。</li>
                        </ul>
                        <button onclick="location.reload()" class="w-full bg-red-600 text-white font-bold py-3 rounded-xl hover:bg-red-700 transition">重新整理</button>
                    </div>
                </div>
            `;
            throw new Error("Firebase apiKey is missing");
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Data ---
        const BEVERAGES_DATA = [
            { id: 'coffee_1', name: '美式咖啡', price: 110, type: 'coffee', temp: 'both' },
            { id: 'coffee_2', name: '原味拿鐵', price: 130, type: 'coffee', temp: 'both' },
            { id: 'coffee_3', name: '焦糖拿鐵', price: 150, type: 'coffee', temp: 'both' },
            { id: 'coffee_4', name: '卡布奇諾', price: 150, type: 'coffee', temp: 'both' },
            { id: 'tea_1', name: '特選錫蘭紅茶', price: 100, type: 'tea', temp: 'both' },
            { id: 'tea_2', name: '阿薩姆紅茶', price: 100, type: 'tea', temp: 'both' },
            { id: 'tea_3', name: '香檸柚茶', price: 100, type: 'tea', temp: 'both' },
            { id: 'tea_4', name: '鐵觀音', price: 110, type: 'tea', temp: 'both' },
            { id: 'tea_5', name: '伯爵紅茶', price: 120, type: 'tea', temp: 'both' },
            { id: 'tea_6', name: '洋甘菊茶', price: 150, type: 'tea', temp: 'hotOnly' },
            { id: 'milktea_1', name: '特選錫蘭奶茶', price: 120, type: 'milkTea', temp: 'both' },
            { id: 'milktea_2', name: '阿薩姆奶茶', price: 120, type: 'milkTea', temp: 'both' },
            { id: 'milktea_3', name: '鐵觀音奶茶', price: 130, type: 'milkTea', temp: 'both' },
            { id: 'milktea_4', name: '伯爵奶茶', price: 140, type: 'milkTea', temp: 'both' },
            { id: 'milktea_5', name: '日式玄米奶茶', price: 150, type: 'milkTea', temp: 'both' },
            { id: 'milktea_6', name: '阿華田可可', price: 150, type: 'milkTea', temp: 'both' },
            { id: 'milktea_7', name: 'OREO 奶茶', price: 150, type: 'milkTea', temp: 'iceOnly' },
            { id: 'juice_1', name: '精力蔬果汁', price: 160, type: 'juice', temp: 'iceOnly' },
            { id: 'juice_2', name: '富士山蘋果牛奶', price: 130, type: 'juice', temp: 'iceOnly' },
            { id: 'juice_3', name: '蜂蜜檸檬', price: 130, type: 'juice', temp: 'iceOnly' },
            { id: 'juice_4', name: '芭樂番茄梅', price: 150, type: 'juice', temp: 'iceOnly' },
            { id: 'juice_5', name: '香蕉牛奶', price: 130, type: 'juice', temp: 'iceOnly' },
            { id: 'juice_6', name: '葡萄優格飲', price: 140, type: 'juice', temp: 'iceOnly' },
            { id: 'smoothie_1', name: '芒果冰沙', price: 140, type: 'smoothie', temp: 'iceOnly' },
            { id: 'smoothie_2', name: '檸檬優格冰沙', price: 140, type: 'smoothie', temp: 'iceOnly' },
            { id: 'smoothie_3', name: '巧克力可可冰沙', price: 150, type: 'smoothie', temp: 'iceOnly' },
            { id: 'smoothie_4', name: 'OREO 餅乾奶昔', price: 160, type: 'smoothie', temp: 'iceOnly' },
        ];
        const BASIC_SIDE_DRINKS = [{ id: 'sd1', name: '香檸柚茶', price: 0, temp: 'both' },{ id: 'sd2', name: '附餐紅茶', price: 0, temp: 'both' },{ id: 'sd3', name: '附餐黑咖啡', price: 0, temp: 'both' }];
        const CATEGORIES = [{ id: 'hotpot', name: '幸福鍋物', icon: 'Soup' },{ id: 'setmeal', name: '幸福二次方', icon: 'Utensils' },{ id: 'pasta', name: '義大利麵/焗烤', icon: 'Utensils' },{ id: 'riceball', name: '普普飯糰餐', icon: 'Utensils' },{ id: 'lightmeal', name: '輕食/沙拉', icon: 'CakeSlice' },{ id: 'snacks', name: '炸物點心', icon: 'IceCream' },{ id: 'alacarte', name: '單點加料', icon: 'Plus' },{ id: 'beverage', name: '飲品單點', icon: 'Coffee' }];
        const PRODUCTS_DATA = [
            { id: 'hp1', categoryId: 'hotpot', name: '日式昆布鍋', price: 330, description: '可全素', modifierRules: { type: 'hotpot', meat: true, spiciness: false, starch: true, drinkType: 'typeB' } },
            { id: 'hp2', categoryId: 'hotpot', name: '韓式泡菜鍋', price: 330, description: '微辣開胃', modifierRules: { type: 'hotpot', meat: true, spiciness: false, starch: true, drinkType: 'typeB' } },
            { id: 'hp3', categoryId: 'hotpot', name: '田園南瓜鍋', price: 340, description: '可全素，濃郁湯頭', modifierRules: { type: 'hotpot', meat: true, spiciness: false, starch: true, drinkType: 'typeB' } },
            { id: 'hp4', categoryId: 'hotpot', name: '辛香麻辣鍋', price: 330, description: '大辣/中辣/小辣', modifierRules: { type: 'hotpot', meat: true, spiciness: true, starch: true, drinkType: 'typeB' } },
            { id: 'hp5', categoryId: 'hotpot', name: '風味牛奶鍋', price: 360, description: '香濃奶香', modifierRules: { type: 'hotpot', meat: true, spiciness: false, starch: true, drinkType: 'typeB' } },
            { id: 'hp6', categoryId: 'hotpot', name: '義式番茄鍋', price: 340, description: '酸甜滋味', modifierRules: { type: 'hotpot', meat: true, spiciness: false, starch: true, drinkType: 'typeB' } },
            { id: 'sm1', categoryId: 'setmeal', name: '蜜汁碳烤豬肋排', price: 490, description: '含小湯鍋', modifierRules: { type: 'setMeal', potType: true, starch: true, drinkType: 'typeB' } },
            { id: 'sm2', categoryId: 'setmeal', name: '香煎厚鮭魚', price: 460, description: '含小湯鍋', modifierRules: { type: 'setMeal', potType: true, starch: true, drinkType: 'typeB' } },
            { id: 'sm3', categoryId: 'setmeal', name: '秘製紹興醉雞', price: 420, description: '含小湯鍋', modifierRules: { type: 'setMeal', potType: true, starch: true, drinkType: 'typeB' } },
            { id: 'sm4', categoryId: 'setmeal', name: '破布子鱈魚', price: 430, description: '含小湯鍋', modifierRules: { type: 'setMeal', potType: true, starch: true, drinkType: 'typeB' } },
            { id: 'sm5', categoryId: 'setmeal', name: '照燒松阪豬', price: 420, description: '含小湯鍋', modifierRules: { type: 'setMeal', potType: true, starch: true, drinkType: 'typeB' } },
            { id: 'sm6', categoryId: 'setmeal', name: '德式鄉村豬腳', price: 430, description: '含小湯鍋', modifierRules: { type: 'setMeal', potType: true, starch: true, drinkType: 'typeB' } },
            { id: 'sm7', categoryId: 'setmeal', name: '法式迷迭香雞腿', price: 370, description: '含小湯鍋', modifierRules: { type: 'setMeal', potType: true, starch: true, drinkType: 'typeB' } },
            { id: 'sm8', categoryId: 'setmeal', name: '泰式檸檬魚', price: 400, description: '含小湯鍋', modifierRules: { type: 'setMeal', potType: true, starch: true, drinkType: 'typeB' } },
            { id: 'sm9', categoryId: 'setmeal', name: '蔥爆野菇牛肉', price: 410, description: '含小湯鍋', modifierRules: { type: 'setMeal', potType: true, starch: true, drinkType: 'typeB' } },
            { id: 'sm10', categoryId: 'setmeal', name: '雲南椒麻雞', price: 380, description: '含小湯鍋', modifierRules: { type: 'setMeal', potType: true, starch: true, drinkType: 'typeB' } },
            { id: 'sm11', categoryId: 'setmeal', name: '如意蔬食(全素)', price: 360, description: '含小湯鍋', modifierRules: { type: 'setMeal', potType: true, starch: true, drinkType: 'typeB' } },
            { id: 'pa1', categoryId: 'pasta', name: '煙燻鴨胸義大利麵', price: 350, description: '醬汁二選一、麵條二選一', modifierRules: { type: 'pasta', sauce: true, noodle: true, drinkType: 'typeB' } },
            { id: 'pa2', categoryId: 'pasta', name: '迷迭雞腿義大利麵', price: 340, description: '醬汁二選一、麵條二選一', modifierRules: { type: 'pasta', sauce: true, noodle: true, drinkType: 'typeB' } },
            { id: 'pa3', categoryId: 'pasta', name: '厚切豬排義大利麵', price: 330, description: '醬汁二選一、麵條二選一', modifierRules: { type: 'pasta', sauce: true, noodle: true, drinkType: 'typeB' } },
            { id: 'pa4', categoryId: 'pasta', name: '香草蛤蠣義大利麵', price: 320, description: '醬汁二選一、麵條二選一', modifierRules: { type: 'pasta', sauce: true, noodle: true, drinkType: 'typeB' } },
            { id: 'pa5', categoryId: 'pasta', name: '嫩煎牛肉義大利麵', price: 350, description: '醬汁二選一、麵條二選一', modifierRules: { type: 'pasta', sauce: true, noodle: true, drinkType: 'typeB' } },
            { id: 'pa6', categoryId: 'pasta', name: '素食鮮果義大利麵', price: 320, description: '五辛素', modifierRules: { type: 'pasta', sauce: true, noodle: true, drinkType: 'typeB' } },
            { id: 'gr1', categoryId: 'pasta', name: '匈牙利牛肉焗烤飯', price: 360, description: '附飲品', modifierRules: { type: 'pasta', drinkType: 'typeB' } },
            { id: 'gr2', categoryId: 'pasta', name: '咖哩雞排焗烤飯', price: 340, description: '附飲品', modifierRules: { type: 'pasta', drinkType: 'typeB' } },
            { id: 'gr3', categoryId: 'pasta', name: '咖哩豬排焗烤飯', price: 330, description: '附飲品', modifierRules: { type: 'pasta', drinkType: 'typeB' } },
            { id: 'gr4', categoryId: 'pasta', name: '蔬食咖哩焗烤飯', price: 320, description: '五辛素', modifierRules: { type: 'pasta', drinkType: 'typeB' } },
            { id: 'rb1', categoryId: 'riceball', name: '豬肋排飯糰餐', price: 330, description: '特製蜜汁照燒醬', modifierRules: { type: 'simpleMeal', drinkType: 'typeA' } },
            { id: 'rb2', categoryId: 'riceball', name: '迷迭雞腿飯糰餐', price: 280, description: '迷迭香氣軟嫩雞腿', modifierRules: { type: 'simpleMeal', drinkType: 'typeA' } },
            { id: 'rb3', categoryId: 'riceball', name: '鹽烤鯖魚飯糰餐', price: 280, description: '檸檬椒鹽搭配', modifierRules: { type: 'simpleMeal', drinkType: 'typeA' } },
            { id: 'lm1', categoryId: 'lightmeal', name: '照燒牛肉輕食', price: 280, description: '輕食總匯', modifierRules: { type: 'simpleMeal', drinkType: 'typeA' } },
            { id: 'lm2', categoryId: 'lightmeal', name: '黃金豬排輕食', price: 260, description: '輕食總匯', modifierRules: { type: 'simpleMeal', drinkType: 'typeA' } },
            { id: 'lm3', categoryId: 'lightmeal', name: '煙燻雞肉輕食', price: 260, description: '輕食總匯', modifierRules: { type: 'simpleMeal', drinkType: 'typeA' } },
            { id: 'sa1', categoryId: 'lightmeal', name: '櫻桃鴨胸沙拉', price: 240, description: '輕食沙拉', modifierRules: { type: 'simpleMeal', drinkType: 'typeA' } },
            { id: 'sa2', categoryId: 'lightmeal', name: '季節水果沙拉', price: 220, description: '輕食沙拉', modifierRules: { type: 'simpleMeal', drinkType: 'typeA' } },
            { id: 'sa3', categoryId: 'lightmeal', name: '煙燻雞肉沙拉', price: 230, description: '輕食沙拉', modifierRules: { type: 'simpleMeal', drinkType: 'typeA' } },
            { id: 'sn1', categoryId: 'snacks', name: '金黃脆薯', price: 100, description: '', modifierRules: {} },
            { id: 'sn2', categoryId: 'snacks', name: '酥炸雞米花', price: 100, description: '', modifierRules: {} },
            { id: 'sn3', categoryId: 'snacks', name: '美味烤雞翅', price: 160, description: '', modifierRules: {} },
            { id: 'sn4', categoryId: 'snacks', name: '招牌甜不辣', price: 100, description: '', modifierRules: {} },
            { id: 'sn5', categoryId: 'snacks', name: '美式洋蔥圈', price: 100, description: '', modifierRules: {} },
            { id: 'sn6', categoryId: 'snacks', name: '黑心麻吉球', price: 100, description: '', modifierRules: {} },
            { id: 'sn7', categoryId: 'snacks', name: '普普綜合拼盤', price: 200, description: '脆薯、雞米花、甜不辣、雞翅、洋蔥圈', modifierRules: {} },
            { id: 'ds1', categoryId: 'snacks', name: '冰心布朗尼', price: 80, description: '甜點', modifierRules: {} },
            { id: 'ds2', categoryId: 'snacks', name: '季節水果鬆餅', price: 240, description: '甜點', modifierRules: {} },
            { id: 'ds3', categoryId: 'snacks', name: '冰淇淋鬆餅', price: 240, description: '甜點', modifierRules: {} },
            { id: 'al1', categoryId: 'alacarte', name: '原味湯底', price: 40, description: '', modifierRules: {} },
            { id: 'al2', categoryId: 'alacarte', name: '火鍋料', price: 60, description: '', modifierRules: {} },
            { id: 'al3', categoryId: 'alacarte', name: '綜合蔬菜', price: 100, description: '', modifierRules: {} },
            { id: 'al4', categoryId: 'alacarte', name: '綜合海鮮', price: 120, description: '', modifierRules: {} },
            { id: 'al5', categoryId: 'alacarte', name: '豬肉盤', price: 100, description: '', modifierRules: {} },
            { id: 'al6', categoryId: 'alacarte', name: '牛肉盤', price: 120, description: '', modifierRules: {} },
            { id: 'al7', categoryId: 'alacarte', name: '綜合菇', price: 80, description: '', modifierRules: {} },
            { id: 'al8', categoryId: 'alacarte', name: '玉米筍/南瓜', price: 60, description: '', modifierRules: {} },
        ];
        const MODIFIER_OPTIONS = {
            meat: [{ id: 'm_pork', name: '豬肉', priceDelta: 0 },{ id: 'm_beef', name: '牛肉', priceDelta: 30 },{ id: 'm_surf_pork', name: '海陸豬', priceDelta: 60 },{ id: 'm_surf_beef', name: '海陸牛', priceDelta: 70 }],
            spiciness: [{ id: 's_little', name: '小辣', priceDelta: 0 },{ id: 's_medium', name: '中辣', priceDelta: 0 },{ id: 's_big', name: '大辣', priceDelta: 0 }],
            starch: [{ id: 'st_rice', name: '白飯', priceDelta: 0 },{ id: 'st_grain', name: '五穀飯', priceDelta: 0 },{ id: 'st_glass', name: '冬粉', priceDelta: 0 }],
            sauce: [{ id: 'sa_green', name: '青醬', priceDelta: 0 },{ id: 'sa_red', name: '紅醬', priceDelta: 0 }],
            noodle: [{ id: 'n_thin', name: '細麵', priceDelta: 0 },{ id: 'n_wide', name: '寬麵', priceDelta: 0 }],
            potType: [{ id: 'pt_fish', name: '鮮魚鍋', priceDelta: 0 },{ id: 'pt_veg', name: '蔬菜鍋', priceDelta: 0 }]
        };

        const MenuContext = createContext();

        const MenuProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [cart, setCart] = useState(JSON.parse(localStorage.getItem('popo_cart')) || []);
            const [selectedCategory, setSelectedCategory] = useState(CATEGORIES[0].id);
            const [isCartOpen, setIsCartOpen] = useState(false);
            const [isAdminView, setIsAdminView] = useState(false);
            const [isAdminLoggedIn, setIsAdminLoggedIn] = useState(false);
            const [customerName, setCustomerName] = useState(localStorage.getItem('popo_name') || "");
            const [toasts, setToasts] = useState([]);
            const [orders, setOrders] = useState([]);

            const addToast = (message, type = 'info') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 3000);
            };
            const removeToast = (id) => setToasts(prev => prev.filter(t => t.id !== id));

            useEffect(() => {
                const init = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (err) {
                        console.error("Login Failed:", err);
                        addToast(`登入失敗: ${err.message}`, 'error');
                    }
                };
                init();
                
                const unsub = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if (u) {
                        const q = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
                        onSnapshot(q, (snapshot) => {
                            setOrders(snapshot.docs.map(d => ({ id: d.id, ...d.data() })));
                        }, (err) => {
                            console.error("DB Error:", err);
                            if(err.code === 'permission-denied') addToast("權限錯誤：請檢查 Firestore Rules", 'error');
                        });
                    }
                });
                return () => unsub();
            }, []);

            useEffect(() => { localStorage.setItem('popo_cart', JSON.stringify(cart)); }, [cart]);
            useEffect(() => { localStorage.setItem('popo_name', customerName); }, [customerName]);

            const addToCart = (item) => { setCart([...cart, { ...item, cartId: Date.now() }]); setIsCartOpen(true); };
            const removeFromCart = (cartId) => setCart(cart.filter(item => item.cartId !== cartId));
            const clearCart = () => { setCart([]); localStorage.removeItem('popo_cart'); };
            const loginAdmin = (password) => password === '0000' && (setIsAdminLoggedIn(true) || setIsAdminView(true));
            const logoutAdmin = () => { setIsAdminLoggedIn(false); setIsAdminView(false); };
            const cartTotal = cart.reduce((total, item) => total + item.finalPrice, 0);

            return (
                <MenuContext.Provider value={{ user, cart, setCart, selectedCategory, setSelectedCategory, isCartOpen, setIsCartOpen, isAdminView, setIsAdminView, isAdminLoggedIn, setIsAdminLoggedIn, customerName, setCustomerName, toasts, addToast, removeToast, orders, db, addToCart, removeFromCart, clearCart, loginAdmin, logoutAdmin, cartTotal, beverages: BEVERAGES_DATA, basicSideDrinks: BASIC_SIDE_DRINKS, modifierOptions: MODIFIER_OPTIONS, products: PRODUCTS_DATA }}>
                    {children}
                </MenuContext.Provider>
            );
        };

        // --- Shared Components ---
        const ToastContainer = () => {
            const { toasts, removeToast } = useContext(MenuContext);
            return (
                <div className="fixed top-4 left-1/2 transform -translate-x-1/2 z-[9999] w-full max-w-sm px-4 space-y-2 pointer-events-none">
                    {toasts.map(t => (
                        <div key={t.id} className={`pointer-events-auto flex items-center px-4 py-3 rounded-xl shadow-xl border-2 transition-all animate-fade-in-up w-full ${t.type === 'error' ? 'bg-red-50 border-red-200 text-red-800' : 'bg-green-50 border-green-200 text-green-800'}`}>
                            <span className="font-bold flex-1">{t.message}</span>
                            <button onClick={() => removeToast(t.id)}><X size={18}/></button>
                        </div>
                    ))}
                </div>
            );
        };

        const CategoryNav = () => {
            const { selectedCategory, setSelectedCategory } = useContext(MenuContext);
            // Helper to get correct icon component
            const getIcon = (name) => {
                const Icon = Icons[name];
                return Icon ? <Icon size={18} className="mr-2"/> : null;
            }

            return (
                <div className="sticky top-[72px] z-30 flex overflow-x-auto py-4 bg-white px-4 border-b">
                    {CATEGORIES.map(c => (
                        <button key={c.id} onClick={() => setSelectedCategory(c.id)} className={`flex items-center flex-shrink-0 px-5 py-2.5 rounded-full font-bold mr-3 border-2 ${selectedCategory===c.id ? 'bg-amber-500 text-white border-amber-500' : 'text-gray-600 border-transparent'}`}>
                            {getIcon(c.icon)}
                            {c.name}
                        </button>
                    ))}
                </div>
            );
        };

        const ProductCard = ({ product, onSelect }) => (
            <div onClick={() => onSelect(product)} className="bg-white rounded-2xl shadow-sm overflow-hidden cursor-pointer hover:shadow-xl hover:border-amber-300 transition-all duration-300 border border-gray-100 p-5 flex flex-col justify-between h-full">
                <div>
                    <div className="flex justify-between items-start mb-2">
                        <h3 className="text-lg font-bold text-gray-800">{product.name}</h3>
                        {product.modifierRules?.drinkType && <span className={`text-[10px] px-2 py-0.5 rounded-full border ${product.modifierRules.drinkType === 'typeB' ? 'bg-blue-50 text-blue-600 border-blue-100' : 'bg-orange-50 text-orange-600 border-orange-100'} font-bold`}>{product.modifierRules.drinkType === 'typeB' ? '附飲品' : '半價購'}</span>}
                        {product.temp === 'iceOnly' && <span className="text-[10px] bg-sky-50 text-sky-600 px-2 py-0.5 rounded font-bold border border-sky-100">限冰飲</span>}
                    </div>
                    {product.description && <p className="text-sm text-gray-500 mb-4">{product.description}</p>}
                </div>
                <div className="flex justify-between items-center border-t border-gray-50 pt-3 mt-2">
                    <span className="text-2xl font-black text-amber-600">${product.price}</span>
                    <button className="bg-amber-50 text-amber-600 p-2 rounded-full hover:bg-amber-500 hover:text-white transition-all shadow-sm"><Plus size={20}/></button>
                </div>
            </div>
        );

        const BeverageCard = ({ drink, onSelect }) => (
             <div onClick={() => onSelect({...drink, categoryId: 'beverage'})} className="bg-white rounded-2xl shadow-sm overflow-hidden cursor-pointer hover:shadow-xl hover:border-amber-300 transition-all duration-300 border border-gray-100 p-5 flex flex-col justify-between h-full">
                <div>
                    <h3 className="text-lg font-bold text-gray-800 mb-2">{drink.name}</h3>
                    <div className="flex space-x-2 mb-3">
                        {drink.temp === 'iceOnly' && <span className="text-[10px] bg-sky-50 text-sky-600 px-2 py-0.5 rounded font-bold border border-sky-100">限冰飲</span>}
                        {drink.temp === 'hotOnly' && <span className="text-[10px] bg-red-50 text-red-600 px-2 py-0.5 rounded font-bold border border-red-100">限熱飲</span>}
                    </div>
                </div>
                <div className="flex justify-between items-center border-t border-gray-50 pt-3 mt-2">
                    <span className="text-2xl font-black text-amber-600">${drink.price}</span>
                    <button className="bg-amber-50 text-amber-600 p-2 rounded-full hover:bg-amber-500 hover:text-white transition-all shadow-sm"><Plus size={20}/></button>
                </div>
            </div>
        );

        // --- Main App ---
        const App = () => {
            const { user, isAdminView, isAdminLoggedIn, setIsAdminView, setShowLoginModal, cart, isCartOpen, setIsCartOpen, selectedCategory, setSelectedCategory, products, beverages, addToCart, removeFromCart, clearCart, customerName, setCustomerName, addToast, orders, db, cartTotal, loginAdmin, logoutAdmin, modifierOptions, basicSideDrinks } = useContext(MenuContext);
            
            const [modalProduct, setModalProduct] = useState(null);
            const [adminEditingItem, setAdminEditingItem] = useState(null);
            const [showLoginModalLocal, setShowLoginModalLocal] = useState(false);

            // --- Sub-Components (Inline for simplicity) ---
            const Navbar = () => (
                <nav className="bg-amber-500 text-white p-4 shadow-md sticky top-0 z-40 flex justify-between items-center h-18 border-b-4 border-amber-600">
                    <div className="flex items-center space-x-3 cursor-pointer" onClick={() => setIsAdminView(false)}>
                        <div className="bg-white text-amber-600 p-2 rounded-xl font-bold text-2xl border-2 border-amber-100 shadow-sm w-12 h-12 flex items-center justify-center">P</div>
                        <div><h1 className="text-xl font-black">普普風</h1></div>
                    </div>
                    <div className="flex items-center space-x-3">
                        <button onClick={() => isAdminLoggedIn ? setIsAdminView(!isAdminView) : setShowLoginModalLocal(true)} className="flex items-center px-3 py-2 rounded-lg bg-amber-600 hover:bg-amber-700 text-sm font-bold">
                            {isAdminView ? <><Utensils size={18} className="mr-1"/>回點餐</> : <><ChefHat size={18} className="mr-1"/>後台</>}
                        </button>
                        {!isAdminView && <button onClick={() => setIsCartOpen(true)} className="relative p-2 bg-white/20 rounded-full hover:bg-white/30"><ShoppingCart size={24}/>{cart.length > 0 && <span className="absolute -top-1 -right-1 bg-red-500 text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold">{cart.length}</span>}</button>}
                        {isAdminView && isAdminLoggedIn && <button onClick={logoutAdmin} className="bg-red-500 p-2 rounded-lg"><LogOut size={16}/></button>}
                    </div>
                </nav>
            );

            // --- Product Modal Logic (Adapted from V9) ---
            const ProductModal = ({ product, onClose }) => {
                const [selections, setSelections] = useState({});
                const [selectedDrink, setSelectedDrink] = useState(null);
                const [drinkTemp, setDrinkTemp] = useState('ice'); 
                const isBev = product.categoryId === 'beverage';
                const rules = product.modifierRules || {};

                const currentPrice = useMemo(() => {
                    let total = product.price;
                    if (isBev) return total; 
                    Object.keys(selections).forEach(key => {
                        const opt = modifierOptions[key]?.find(o => o.id === selections[key]);
                        if(opt) total += opt.priceDelta;
                    });
                    if (selectedDrink) {
                        if (selectedDrink.isUpgrade || rules.drinkType === 'typeA') total += (selectedDrink.price / 2);
                        else total += selectedDrink.price;
                    }
                    return total;
                }, [selections, selectedDrink, drinkTemp]);

                const handleAdd = () => {
                    if(!isBev) {
                        if (rules.meat && !selections.meat) return addToast('漏選肉品', 'error');
                        if (rules.spiciness && !selections.spiciness) return addToast('漏選辣度', 'error');
                        if (rules.starch && !selections.starch) return addToast('漏選主食', 'error');
                        if (rules.drinkType === 'typeB' && !selectedDrink) return addToast('漏選飲品', 'error');
                    }
                    
                    let details = [];
                    if(isBev) details.push(product.temp === 'both' ? (drinkTemp === 'ice' ? '(冰)' : '(熱)') : '');
                    else {
                        Object.keys(selections).forEach(k => { const opt = modifierOptions[k]?.find(o => o.id === selections[k]); if(opt) details.push(opt.name); });
                        if(selectedDrink) details.push(`${selectedDrink.name}${selectedDrink.temp==='both'?(drinkTemp==='ice'?'(冰)':'(熱)'):''} ${selectedDrink.isUpgrade?'(半價)':''}`);
                    }

                    addToCart({
                        id: product.id, productId: product.id, name: product.name,
                        basePrice: product.price, finalPrice: currentPrice,
                        details: details.join(', '), selections: { ...selections, selectedDrink, drinkTemp }
                    });
                    onClose();
                };

                return (
                    <div className="fixed inset-0 bg-black/60 z-50 flex justify-center items-end sm:items-center p-0 sm:p-4">
                        <div className="bg-white w-full max-w-2xl h-[95vh] sm:h-auto rounded-t-2xl sm:rounded-3xl flex flex-col overflow-hidden">
                            <div className="bg-amber-500 p-6 text-white relative">
                                <h2 className="text-3xl font-black">{product.name}</h2>
                                <button onClick={onClose} className="absolute top-4 right-4 bg-white/20 p-2 rounded-full"><X/></button>
                            </div>
                            <div className="p-6 overflow-y-auto flex-1">
                                {isBev && product.temp === 'both' && (
                                    <div className="mb-4">
                                        <h4 className="font-bold mb-2">溫度</h4>
                                        <div className="flex gap-2"><button onClick={() => setDrinkTemp('ice')} className={`flex-1 py-2 border rounded ${drinkTemp==='ice'?'bg-blue-100 border-blue-400 text-blue-700':''}`}>冰</button><button onClick={() => setDrinkTemp('hot')} className={`flex-1 py-2 border rounded ${drinkTemp==='hot'?'bg-red-100 border-red-400 text-red-700':''}`}>熱</button></div>
                                    </div>
                                )}
                                {rules.meat && <div className="mb-4"><h4 className="font-bold mb-2">肉品</h4><div className="grid grid-cols-2 gap-2">{modifierOptions.meat.map(o => <button key={o.id} onClick={() => setSelections({...selections, meat: o.id})} className={`p-2 border rounded ${selections.meat===o.id?'bg-amber-100 border-amber-500':''}`}>{o.name}</button>)}</div></div>}
                                {rules.spiciness && <div className="mb-4"><h4 className="font-bold mb-2">辣度</h4><div className="grid grid-cols-3 gap-2">{modifierOptions.spiciness.map(o => <button key={o.id} onClick={() => setSelections({...selections, spiciness: o.id})} className={`p-2 border rounded ${selections.spiciness===o.id?'bg-amber-100 border-amber-500':''}`}>{o.name}</button>)}</div></div>}
                                {/* Simplified logic for brevity in one-file fix */}
                                {rules.drinkType && (
                                    <div className="mb-4 border-t pt-4">
                                        <h4 className="font-bold mb-2">飲品</h4>
                                        <div className="space-y-2">
                                            {basicSideDrinks.map(d => (
                                                <div key={d.id} onClick={() => setSelectedDrink({...d, isUpgrade: false})} className={`p-3 border rounded flex justify-between cursor-pointer ${selectedDrink?.id===d.id&&!selectedDrink.isUpgrade?'bg-amber-100 border-amber-500':''}`}>
                                                    <span>{d.name}</span>
                                                    {selectedDrink?.id===d.id && d.temp==='both' && <div className="flex gap-1"><button onClick={(e)=>{e.stopPropagation();setDrinkTemp('ice')}} className={`px-2 rounded ${drinkTemp==='ice'?'bg-blue-200':''}`}>冰</button><button onClick={(e)=>{e.stopPropagation();setDrinkTemp('hot')}} className={`px-2 rounded ${drinkTemp==='hot'?'bg-red-200':''}`}>熱</button></div>}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                            <div className="p-4 border-t flex justify-between items-center">
                                <span className="text-3xl font-black text-amber-600">${currentPrice}</span>
                                <button onClick={handleAdd} className="bg-amber-500 text-white px-8 py-3 rounded-xl font-bold">加入購物車</button>
                            </div>
                        </div>
                    </div>
                );
            };

            // --- Admin Dashboard (Grouped Orders) ---
            const AdminDashboard = () => {
                const mergedOrders = useMemo(() => {
                    const groups = {};
                    orders.forEach(o => {
                        const name = o.userName || 'Unknown';
                        if(!groups[name]) groups[name] = { userName: name, totalAmount: 0, latest: 0, docIds: [], items: [] };
                        groups[name].totalAmount += Number(o.totalAmount);
                        if(o.createdAt > groups[name].latest) groups[name].latest = o.createdAt;
                        groups[name].docIds.push(o.id);
                        if(o.items) o.items.forEach((item, idx) => groups[name].items.push({...item, _docId: o.id, _itemIdx: idx}));
                    });
                    return Object.values(groups).sort((a,b) => b.latest - a.latest);
                }, [orders]);

                const totalRev = orders.reduce((acc, o) => acc + Number(o.totalAmount), 0);

                const deleteMerged = async (docIds) => {
                    // Safe delete using double check or confirm
                    if(confirm("確定刪除此客戶的所有訂單？")) {
                        await Promise.all(docIds.map(id => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id))));
                        addToast('已刪除', 'success');
                    }
                };

                const updateItem = async (updatedItem) => {
                    const order = orders.find(o => o.id === updatedItem._docId);
                    if(order) {
                        const newItems = [...order.items];
                        // remove meta
                        const { _docId, _itemIdx, ...clean } = updatedItem;
                        newItems[updatedItem._itemIdx] = clean;
                        const newTotal = newItems.reduce((a,b) => a+Number(b.finalPrice), 0);
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', updatedItem._docId), { items: newItems, totalAmount: newTotal });
                        setAdminEditingItem(null);
                        addToast('已更新', 'success');
                    }
                };

                return (
                    <div className="container mx-auto p-4 max-w-5xl">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-black text-gray-800 flex items-center"><ChefHat className="mr-2"/> 訂單管理系統</h2>
                            <div className="text-xl font-bold text-amber-600">總營收: ${totalRev}</div>
                        </div>
                        <div className="grid gap-6 md:grid-cols-2">
                            {mergedOrders.map((order, i) => (
                                <div key={i} className="bg-white rounded-2xl shadow-sm border-l-8 border-amber-500 p-4">
                                    <div className="flex justify-between border-b pb-2 mb-2">
                                        <div>
                                            <h3 className="font-bold text-lg">{order.userName}</h3>
                                            <p className="text-xs text-gray-500">{new Date(order.latest).toLocaleTimeString()}</p>
                                        </div>
                                        <div className="flex items-center space-x-2">
                                            <span className="font-black text-xl">${order.totalAmount}</span>
                                            <button onClick={() => deleteMerged(order.docIds)} className="text-red-400 hover:bg-red-50 p-1 rounded"><Trash2 size={18}/></button>
                                        </div>
                                    </div>
                                    <ul className="space-y-2">
                                        {order.items.map((item, idx) => (
                                            <li key={idx} className="flex justify-between items-center text-sm">
                                                <span>{item.name} <span className="text-gray-400 text-xs">{item.details}</span></span>
                                                <div className="flex items-center">
                                                    <span className="font-bold mr-2">${item.finalPrice}</span>
                                                    {item.productId && <button onClick={() => setAdminEditingItem(item)} className="text-blue-400"><Edit3 size={14}/></button>}
                                                </div>
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen">
                    {/* Navbar */}
                    <nav className="bg-amber-500 text-white p-4 shadow-md sticky top-0 z-40 flex justify-between items-center h-18 border-b-4 border-amber-600">
                        <div className="flex items-center space-x-3 cursor-pointer" onClick={() => setIsAdminView(false)}>
                            <div className="bg-white text-amber-600 p-2 rounded-xl font-bold text-2xl border-2 border-amber-100 shadow-sm w-12 h-12 flex items-center justify-center">P</div>
                            <div><h1 className="text-xl font-black">普普風</h1></div>
                        </div>
                        <div className="flex items-center space-x-3">
                            <button onClick={() => isAdminLoggedIn ? setIsAdminView(!isAdminView) : setShowLoginModalLocal(true)} className="flex items-center px-3 py-2 rounded-lg bg-amber-600 hover:bg-amber-700 text-sm font-bold">
                                {isAdminView ? <><Utensils size={18} className="mr-1"/>回點餐</> : <><ChefHat size={18} className="mr-1"/>後台</>}
                            </button>
                            {!isAdminView && <button onClick={() => setIsCartOpen(true)} className="relative p-2 bg-white/20 rounded-full hover:bg-white/30"><ShoppingCart size={24}/>{cart.length > 0 && <span className="absolute -top-1 -right-1 bg-red-500 text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold">{cart.length}</span>}</button>}
                            {isAdminView && isAdminLoggedIn && <button onClick={logoutAdmin} className="bg-red-500 p-2 rounded-lg"><LogOut size={16}/></button>}
                        </div>
                    </nav>

                    {/* Content */}
                    {isAdminView && isAdminLoggedIn ? <AdminDashboard/> : (
                        <div>
                             <CategoryNav />
                             <main className="container mx-auto p-4 grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                {(selectedCategory === 'beverage' ? beverages : products.filter(p => p.categoryId === selectedCategory)).map(p => 
                                    (selectedCategory === 'beverage') ? 
                                    <BeverageCard key={p.id} drink={p} onSelect={setModalProduct} /> :
                                    <ProductCard key={p.id} product={p} onSelect={setModalProduct} />
                                )}
                             </main>
                        </div>
                    )}
                    {modalProduct && <ProductModal product={modalProduct} onClose={() => setModalProduct(null)} />}
                    {isCartOpen && (
                        <div className="fixed inset-0 z-50 flex justify-end">
                            <div className="absolute inset-0 bg-black/50" onClick={() => setIsCartOpen(false)}></div>
                            <div className="relative bg-white w-full max-w-md h-full shadow-2xl flex flex-col">
                                <div className="p-4 border-b flex justify-between bg-amber-50"><h2 className="font-black text-xl">購物車</h2><button onClick={() => setIsCartOpen(false)}><X/></button></div>
                                <div className="flex-1 p-4 overflow-y-auto">
                                    {cart.map(item => (
                                        <div key={item.cartId} className="border p-3 rounded mb-2 relative">
                                            <div className="flex justify-between font-bold"><span>{item.name}</span><span>${item.finalPrice}</span></div>
                                            <div className="text-xs text-gray-500">{item.details}</div>
                                            <button onClick={() => removeFromCart(item.cartId)} className="absolute top-2 right-2 text-red-400"><Trash2 size={16}/></button>
                                        </div>
                                    ))}
                                </div>
                                <div className="p-4 border-t space-y-3">
                                    <input className="w-full p-2 border rounded font-bold" placeholder="姓名" value={customerName} onChange={e => setCustomerName(e.target.value)} />
                                    <div className="flex justify-between font-black text-xl"><span>總計</span><span>${cartTotal}</span></div>
                                    <button onClick={async () => {
                                        if(!customerName) return addToast('請輸入姓名', 'error');
                                        if(!user) return addToast('連線中...', 'error');
                                        try {
                                            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), { userName: customerName, items: cart, totalAmount: cartTotal, userId: user.uid, createdAt: Date.now() });
                                            clearCart(); setIsCartOpen(false); addToast('訂單已送出', 'success');
                                        } catch(e) { console.error(e); addToast('送出失敗', 'error'); }
                                    }} className="w-full bg-green-600 text-white py-3 rounded font-bold">送出</button>
                                </div>
                            </div>
                        </div>
                    )}
                    {showLoginModalLocal && (
                        <div className="fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-4">
                            <div className="bg-white p-6 rounded-2xl w-full max-w-sm">
                                <h3 className="font-black text-xl mb-4">管理員登入 (0000)</h3>
                                <input type="password" id="local-pass" className="w-full p-3 border rounded mb-4 text-center" />
                                <div className="flex gap-2"><button onClick={() => setShowLoginModalLocal(false)} className="flex-1 py-2 text-gray-500">取消</button><button onClick={() => { if(document.getElementById('local-pass').value === '0000') { loginAdmin('0000'); setShowLoginModalLocal(false); } else addToast('密碼錯誤', 'error'); }} className="flex-1 py-2 bg-amber-500 text-white rounded font-bold">登入</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MenuProvider><App /></MenuProvider>);
    </script>
</body>
</html>
